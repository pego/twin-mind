# Twin-Mind v1.1 Design Document

**Date:** 2025-01-22
**Goal:** Personal tool polish + Claude Code integration improvements
**Approach:** Single-file architecture, no new dependencies

---

## 1. Configuration System

**Location:** `.claude/settings.json` under `"twin-mind"` key

```json
{
  "twin-mind": {
    "extensions": {
      "include": [".py", ".js", ".ts", ".tsx"],
      "exclude": [".min.js", ".bundle.js"]
    },
    "skip_dirs": ["node_modules", "dist", "my_custom_dir"],
    "max_file_size": "500KB",
    "index": {
      "auto_incremental": true,
      "track_deletions": true
    },
    "output": {
      "color": true,
      "verbose": false
    }
  }
}
```

**Behavior:**
- Config is optional â€” sensible defaults if missing
- Merged with defaults (user config overrides, doesn't replace entirely)
- `extensions.include` adds to defaults, `extensions.exclude` removes from indexing
- Loaded once at startup, cached for session

**New helper functions:**
- `load_config()` â†’ Returns merged config dict
- `get_extensions()` â†’ Returns final set of extensions
- `get_skip_dirs()` â†’ Returns final set of directories to skip

---

## 2. Git-Based Incremental Indexing

**State tracking:** `.claude/index-state.json`
```json
{
  "last_commit": "abc123def",
  "indexed_at": "2025-01-22T10:30:00",
  "file_count": 847
}
```

**Algorithm:**
1. Read last commit SHA from state file
2. Run `git diff --name-only <last_commit> HEAD` for changed files
3. Run `git diff --name-only --diff-filter=D <last_commit> HEAD` for deleted files
4. Only reindex changed files, remove deleted entries
5. Update state file with new commit SHA

**Fallback behavior:**
- Not a git repo â†’ full reindex with warning
- Last commit not found (rebased) â†’ full reindex
- `--fresh` flag â†’ always full reindex

**Commands:**
- `twin-mind index` â€” Incremental (default)
- `twin-mind index --fresh` â€” Full reindex
- `twin-mind index --status` â€” Preview without executing

**Output:**
```
ğŸ“‚ Incremental index (since abc123d)
   Changed: 12 files
   Deleted: 3 files
   Skipped: 832 unchanged
âœ… Index updated in 0.8s
```

---

## 3. Prune Command Implementation

**Strategy:** Filtered rebuild (export â†’ filter â†’ rebuild â†’ atomic swap)

**Syntax:**
```bash
twin-mind prune --before 30d              # Older than 30 days
twin-mind prune --before 2024-01-01       # Before specific date
twin-mind prune --tag session             # All with tag "session"
twin-mind prune --before 7d --tag session # Combine filters (AND)
twin-mind prune --dry-run                 # Preview only
```

**Safety:**
- Always requires confirmation (unless `--force`)
- `--dry-run` shows count and sample
- Auto-backup to `.claude/memory.mv2.backup`
- Preserves "system" tagged entries

**Output:**
```
ğŸ” Prune preview:
   Matching: 47 memories
   - "Modified: src/auth.js" [session] (2025-01-15)
   ... and 45 more

âš ï¸  Delete 47 memories? [y/N]: y
ğŸ’¾ Backed up to .claude/memory.mv2.backup
âœ… Pruned 47 memories (109 remaining)
```

---

## 4. Error Handling & Robustness

**Corrupt file recovery:**
```python
try:
    mem = Memvid.open(str(code_path))
except Exception as e:
    print("âš ï¸  Code store corrupted or incompatible")
    print(f"   Error: {e}")
    print("   Run: twin-mind reset code")
    sys.exit(1)
```

**File locking:**
- `.claude/*.lock` files during write operations
- 5-second timeout with clear error
- Auto-cleanup of stale locks (>60s old)

**Graceful degradation:**

| Scenario | Behavior |
|----------|----------|
| memvid-sdk missing | Clear install instructions, exit 1 |
| Not a git repo | Warning, fall back to full index |
| Config parse error | Warning, use defaults |
| Single file unreadable | Skip with --verbose log, continue |
| Store locked | Wait 5s, then error with PID info |

**Logging:**
- Default: errors and summaries
- `--verbose` / `-v`: each file processed
- `--quiet` / `-q`: errors only
- stderr for logs, stdout for results

---

## 5. UX Improvements

**Colored output (ANSI, no deps):**
- âœ… Green â€” Success
- âš ï¸ Yellow â€” Warnings
- âŒ Red â€” Errors
- ğŸ”µ Blue â€” Info
- Disable: `--no-color` or `NO_COLOR=1` env var

**Progress indicator:**
```
ğŸ“‚ Indexing: [=====>    ] 234/847 files (28%)
```

**Dry-run support:**
```bash
twin-mind index --dry-run
twin-mind reset code --dry-run
twin-mind prune --dry-run
```

**New commands:**
```bash
twin-mind status    # Health check (stats + git state)
twin-mind reindex   # Alias: reset code && index --fresh
```

**Improved stats:**
```
ğŸ§  Twin-Mind Status
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“„ Code     2.4 MB â”‚ 847 files â”‚ indexed 2h ago
ğŸ“ Memory   124 KB â”‚ 156 entries â”‚ last: 15m ago
ğŸ”— Git      main @ abc123d (3 commits ahead of index)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 6. Claude Code Integration

**Improved search:**
```bash
twin-mind search "auth" --context 10   # Lines before/after
twin-mind search "auth" --full         # Full file content
```

**Structured JSON output:**
```json
{
  "query": "middleware",
  "results": [{
    "source": "code",
    "file": "src/auth/middleware.py",
    "language": "python",
    "score": 0.92,
    "snippet": "def auth_middleware...",
    "line_start": 45,
    "line_end": 78
  }],
  "meta": {
    "index_age": "2h",
    "total_files": 847
  }
}
```

**New agent-friendly commands:**
```bash
twin-mind remember-file <path>  # Auto-summarize file changes
twin-mind context <query>       # Combined code+memory for prompts
```

**Auto-stale warning:**
```
âš ï¸  Index may be stale (15 commits behind)
   Run: twin-mind index
```

---

## 7. Implementation Plan

**Files to modify/create:**

| File | Action |
|------|--------|
| `scripts/twin-mind.py` | Major updates |
| `SKILL.md` | Update commands/triggers |
| `README.md` | Update documentation |
| `references/advanced.md` | Config reference |
| `CHANGELOG.md` | New |
| `LICENSE` | New (MIT) |

**No new dependencies** â€” all stdlib

**Version:** 1.0.0 â†’ 1.1.0

**Backwards compatible:** All existing commands and files work unchanged
